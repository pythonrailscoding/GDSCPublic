{% extends 'base.html' %}
{% load static %}
{% block title %} View Post {% endblock %}
{% block content %}
    <link rel="stylesheet" href="{% static 'css/view_blog.css' %}">
    <!-- Blog Container -->
    <div class="main-content">
    <div class="blog-container">
        <div class="blog-card">

            <!-- Thumbnail -->
            {% if blog.thumbnail %}
                <div class="blog-thumbnail">
                    <img src="{{ blog.thumbnail.url }}" alt="Thumbnail for {{ blog.title }}">
                </div>
            {% endif %}

            <!-- Blog Title -->
            <h1 class="blog-title">{{ blog.title }}</h1>

            <!-- Meta Information -->
            <div class="blog-meta">
                <span class="author">‚úçÔ∏è <a href="{% url 'profile_user' blog.user.id %}" class="underline-special">{{ blog.user.username }}</a></span>
                <span class="date">üìÖ {{ blog.date|date:"F j, Y" }}</span>
                <span class="time">‚è∞ {{ blog.time|time:"g:i A" }}</span>
            </div>
        <p style="text-align: center">{% if blog.was_updated %}Updated last on  {{ blog.when_last_updated }}{% endif %}</p>
                 <!-- Edit / Delete Buttons (only for author) -->
    {% if request.user.id == blog.user.id %}
    <div class="blog-actions">
        <a href="{% url 'update_blog' blog.id %}" class="btn-edit" style="text-decoration: none;">‚úèÔ∏è Edit</a>
        <button class="btn-delete" onclick="openDeleteModal()">üóëÔ∏è Delete</button>
    </div>
    {% endif %}


            <!-- Blog Body -->
            <div class="blog-body">
                <div style="color: black;">
                    {{ blog.content|safe }}
                </div>
            </div>

        </div>
        <!-- Comments Section (20%) -->
    <div class="comments-section">
        <h2>Comments</h2>
        <!-- Comment Form -->
    {% if request.user.is_authenticated %}
        <form method="POST" id="comment-form" class="comment-form">
            {% csrf_token %}
            <textarea id="comment-text" name="text" required></textarea>
            <button type="submit">Comment</button>
        </form>
        {% else %}
         You need to Log in to comment!
    {% endif %}
        <div id="comment-list">
            {% for comment in blog.comments.all %}
                <div class="comment">
                    <p><strong><a href="{% url 'profile_user' comment.user.id %}" class="underline-special">{{ comment.user.username }}</a></strong></p>
                    <p>{{ comment.content }}</p>
                    <small>{{ comment.created_at }}</small>
                </div>
            {% empty %}
                <p>No comments yet. {% if request.user.is_authenticated %} Be the first! {% else %} <a href="{% url 'login' %}"> Login </a>to comment {% endif %}</p>
            {% endfor %}
        </div>
    </div>
    </div>
    </div>

    <!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>Are you sure to delete this blog?</h3>
    <p>This action cannot be undone.</p>
    <div class="modal-actions">
      <form id="deleteForm" method="post" action="{% url 'delete_blog' blog.id %}">
        {% csrf_token %}
        <button type="submit" class="confirm-btn">Yes, Delete</button>
      </form>
      <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>
</div>
    <script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("comment-form");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    const response = await fetch("{% url 'add_comment' blog.id %}", {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": "{{ csrf_token }}"
        }
    });

    if (response.ok) {
        const data = await response.json();

        if (data.html) {
            const list = document.getElementById("comment-list");
            list.insertAdjacentHTML("afterbegin", data.html);
            form.reset();
        } else {
            console.error("No HTML returned:", data);
        }
    } else {
        console.error("Request failed", response.status);
    }
});

});
function openDeleteModal() {
  document.getElementById("deleteModal").style.display = "flex";
}

function closeDeleteModal() {
  document.getElementById("deleteModal").style.display = "none";
}
</script>

{% endblock %}
